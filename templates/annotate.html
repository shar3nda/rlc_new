{% extends "base.html" %}
{% load static %}
{% block title %}{{ document.title }}{% endblock %}
{% load i18n %}

{% block content %}
  <div class="container mt-5">
    <div class="row">
      <div class="col-md-8">
        <div class="card mb-3">
          <div class="card-body">
            {% if perms.corpus.change_document %}
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="form-group mb-0">
                  <label for="document-status" class="me-2">{% trans "Document status" %}</label>
                  <select class="form-select form-select-sm d-inline-block" id="document-status" style="width: auto;">
                    <option value="0"
                            {% if document.status == 0 %}selected{% endif %}>{% trans "Not annotated" %}</option>
                    <option value="1" {% if document.status == 1 %}selected{% endif %}>{% trans "Annotated" %}</option>
                    <option value="2" {% if document.status == 2 %}selected{% endif %}>{% trans "Checked" %}</option>
                  </select>
                </div>
              </div>
            {% endif %}
            {% include 'document_card.html' with annotate_view=True %}
            {% for sentence in sentences %}
              {% include 'sentence_card.html' with sentence=sentence %}
            {% endfor %}
            <p class="card-text"><small class="text-muted">{{ document.created_on }}</small></p>
          </div>
        </div>
      </div>
      <div class="col-md-4 card card-body">
        <ul class="nav custom-nav">
          <li>Orthography
            <ul>
              <li>Graph <a href="#" data-toggle="tooltip" title="Смешение алфавитов"><i class="fas fa-question"></i></a></li>
              <li>Hyphen <a href="#" data-toggle="tooltip" title="Ошибки в дефисном написании"><i class="fas fa-question"></i></a></li>
              <li>Space <a href="#" data-toggle="tooltip" title="Ошибка в слитно-раздельном написании"><i class="fas fa-question"></i></a></li>
              <li>Ortho <a href="#" data-toggle="tooltip" title="Прочие орфографические ошибки"><i class="fas fa-question"></i></a></li>
              <li>Translit <a href="#" data-toggle="tooltip" title="Неверная транлитерация имени собственного"><i class="fas fa-question"></i></a></li>
              <li>Misspell <a href="#" data-toggle="tooltip" title="Комплексная ошибка, затрагивающая несколько букв (трансформировано написание слова в целом)"><i class="fas fa-question"></i></a></li>
            </ul>
          </li>
          <li>Morphology
            <ul>
              <li>Deriv <a href="#" data-toggle="tooltip"
                           title="Случаи словотворчества, когда студент, используя приставки и/или суффиксы, создаёт несуществующее слово"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Infl <a href="#" data-toggle="tooltip"
                          title="Использование окончания, которое отсутствует в парадигме данного слова"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Num <a href="#" data-toggle="tooltip"
                         title="Употребление слова в неверной числовой форме (несоответствующей контексту или аномальной для этого слова)"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Gender <a href="#" data-toggle="tooltip" title="Изменение родовой принадлежности слова"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Altern <a href="#" data-toggle="tooltip"
                            title="Ошибка в чередовании основы, например, любю вместо люблю"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Morph <a href="#" data-toggle="tooltip" title="Прочие морфологические ошибки"
              ><i class="fas fa-question"
              ></i></a></li>
            </ul>
          </li>
          <li>Syntax
            <ul>
              <li>Asp <a href="#" data-toggle="tooltip"
                         title="Неверная видовая форма или неверный выбор глаголов ненаправленного или повторяющегося движения (ср. ехать - ездить)"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>ArgStr <a href="#" data-toggle="tooltip"
                            title="Ошибки в аргументной структуре глагола, существительного или прилагательного"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Passive <a href="#" data-toggle="tooltip" title="Неверное использование пассива"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Mode <a href="#" data-toggle="tooltip"
                          title="Ошибка в использовании условного наклонения или образовании формы условного наклонения (пропуск частицы бы, не - в вопросах типа «Не могли бы вы прислать мне инструкцию?»)"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Tense <a href="#" data-toggle="tooltip"
                           title="Ошибка во временной форме глагола (например, когда по контексту ясно, что требуется прошедшее время, а студент употребил настоящее). NB! Тег описывает только ошибки во времени глагола, не в виде - видовые ошибки маркируются тегом Asp"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Refl <a href="#" data-toggle="tooltip" title="Неверное употребление возвратных глаголов"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>AgrNum <a href="#" data-toggle="tooltip" title="Ошибка в согласовании по числу"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>AgrCase <a href="#" data-toggle="tooltip"
                             title="Ошибка в согласовании по падежу (NB Тег AgrCase не используется в случаях нарушения падежного управления: ср. с этом значением vs стречала с мою подрушку. Ошибка в управлении описывается тегом Gov)"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>AgrGender <a href="#" data-toggle="tooltip"
                               title="Ошибка в согласовании по роду (прилагательных, причастий, местоимений или глаголов прошедшего времени)"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>AgrPers <a href="#" data-toggle="tooltip" title="Неверное согласование сказуемого по лицу"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>AgrGerund <a href="#" data-toggle="tooltip" title="Ошибка в согласовании деепричастия"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Gov <a href="#" data-toggle="tooltip"
                         title="Ошибка в управлении (NB Тег Gov не используется в случаях нарушения согласования по падежу: ср. стречала с мою подрушку vs с этом значением. Ошибка в падежном согласовании описывается тегом AgrCase)"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Ref <a href="#" data-toggle="tooltip"
                         title="Ошибки в употреблении местоимений (пропуск или неверный выбор местоимения)"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Conj <a href="#" data-toggle="tooltip" title="Ошибка в употреблении союза"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>WO <a href="#" data-toggle="tooltip" title="Ошибка в порядке слов"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Neg <a href="#" data-toggle="tooltip" title="Неверная постановка отрицания"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Aux <a href="#" data-toggle="tooltip"
                         title="Неверное употребление глагола «есть», глаголов-связок"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Brev <a href="#" data-toggle="tooltip" title="Употребление кратких/полных прилагательных"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>GenNeg<a href="#" data-toggle="tooltip" title="Ошибка в отрицании при инфинитиве"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Impers<a href="#" data-toggle="tooltip"
                           title="Ошибки в безличных и неопределенно личных конструкциях"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Syntax <a href="#" data-toggle="tooltip"
                            title="Прочие синтаксические ошибки, не описанные в классификации"
              ><i class="fas fa-question"
              ></i></a></li>
            </ul>
          </li>
          <li>Construction
            <ul>
              <li>Constr <a href="#" data-toggle="tooltip"
                            title="Неверный выбор конструкции или ошибка внутри конструкции (ошибка затрагивает выбор или форму более одной единицы или связана с пропуском/добавлением единицы)"
              ><i class="fas fa-question"
              ></i></a></li>
            </ul>
          </li>
          <li>Lexis
            <ul>
              <li>Lex <a href="#" data-toggle="tooltip" title="Неверное словоупотребление"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Prep <a href="#" data-toggle="tooltip" title="Ошибка в употреблении предлога"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>CS <a href="#" data-toggle="tooltip"
                        title="Code-switching (использование иноязычного слова, написанного латиницей или кириллицей)"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Par <a href="#" data-toggle="tooltip" title="Паронимия">
                <i class="fas fa-question"></i></a></li>
              <li>Idiom <a href="#" data-toggle="tooltip"
                           title="Ошибка в употреблении устойчивого словосочетания"
              ><i class="fas fa-question"
              ></i></a></li>
            </ul>
          </li>
          <li>Additional tags
            <ul>
              <li>Transfer <a href="#" data-toggle="tooltip" title="Интерференция с L1"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Not-clear <a href="#" data-toggle="tooltip"
                               title="По контексту невозможно восстановить смысл фразы и исправить ошибку"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Miss <a href="#" data-toggle="tooltip" title="Пропуск буквы, морфемы или слова"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Extra <a href="#" data-toggle="tooltip"
                           title="Вставка ненужной элемента (буквы, морфемы или слова)"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Transp <a href="#" data-toggle="tooltip"
                            title="Перестановка двух соседних элементов (буквы, морфемы или слова)"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Subst <a href="#" data-toggle="tooltip" title="Замена буквы, морфемы или слова"
              ><i class="fas fa-question"
              ></i></a></li>
              <li>Disc <a href="#" data-toggle="tooltip"
                          title=" Ошибка в дискурсе(?)(Испл. совместно с Lex, WO или Constr)"
              ><i class="fas fa-question"
              ></i></a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <script>
    $("#document-status").change(function () {
      var status = $(this).val();
      var documentId = "{{ document.id }}";
      var csrfToken = getCSRFToken();

      $.ajax({
        url: "{% url 'update_document_status' document.id %}",
        method: "POST",
        data: {
          'status': status,
          'csrfmiddlewaretoken': csrfToken,
        },
        success: function (data) {
          if (data.status === 'success') {
            console.log("Document status updated successfully.");
            // reload the page
            location.reload();
          } else {
            console.error("Error updating document status.");
          }
        },
        error: function () {
          console.error("Error updating document status.");
        }
      });
    });

    $(document).ready(function () {
      $('[data-toggle="tooltip"]').tooltip();
    });

    function updateCorrections(sentenceId) {
      const url = `/api/get_corrections/${sentenceId}`;

      $.ajax({
        type: "GET",
        url: url,
        success: function (response) {
          // Update the correction and alt_correction fields on the page
          const correction = response.correction;
          const altCorrection = response.alt_correction;

          $(`#correction-${sentenceId}`).text(correction);
          $(`#alt-correction-${sentenceId}`).text(altCorrection);
        },
        error: function (xhr, status, error) {
          console.error("Error updating corrections:", error);
        }
      });
    }

    function refreshCorrections() {
      {% for sentence in sentences %}
        updateCorrections({{ sentence.id }});
      {% endfor %}
    }


    document.addEventListener('DOMContentLoaded', function () {
      initRecogito(
          {% if perms.corpus.add_annotation %}true{% else %}false{% endif %},
          {% if user.is_authenticated %}true{% else %}false{% endif %}
      );
    });


    function getSentenceErrors(sentence_id) {
      const url = `/api/get_sentence_errors/${sentence_id}`;

      $.ajax({
        type: "GET",
        url: url,
        dataType: 'json',
        success: function (data) {
          var errors = data.errors;

          // Correctly define sentenceElement here before using it
          var sentenceElement = document.getElementById('sentence-' + sentence_id);
          var wordSpans = sentenceElement.getElementsByTagName('span');
          for (var i = 0; i < wordSpans.length; i++) {
            // If the span's text is in the errors array, add the "error" class
            if (errors.includes(wordSpans[i].innerText)) {
              wordSpans[i].classList.add('error');
            }
          }
        }
      });
    }


    $(document).ready(function () {
      {% for sentence in sentences %}
        getSentenceErrors({{ sentence.id }});
      {% endfor %}
    });
  </script>
{% endblock %}