{% extends "base.html" %}
{% load static %}
{% block title %}{{ document.title }}{% endblock %}

{% block content %}
  <div class="container mt-5">
    <div class="row">
      <div class="col-md-8">
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title">{{ document.title }}</h5>
              <div class="form-group mb-0">
                <label for="document-status" class="me-2">Статус документа:</label>
                <select class="form-select form-select-sm d-inline-block" id="document-status" style="width: auto;">
                  <option value="0" {% if document.status == 0 %}selected{% endif %}>Не аннотирован</option>
                  <option value="1" {% if document.status == 1 %}selected{% endif %}>Аннотирован</option>
                  <option value="2" {% if document.status == 2 %}selected{% endif %}>Проверен</option>
                </select>
              </div>
            </div>
            {% for sentence in sentences %}
              <div class="card mb-2" style="max-width: 100%;" data-card-id="{{ sentence.id }}">
  <div class="card-body position-relative pb-4" id="sentence-card-{{ sentence.id }}">
    <div id="sentence-{{ sentence.id }}" data-sentence-id="{{ sentence.id }}" data-document-id="{{ document.id }}"
         data-user-id="{{ user.id }}" data-alt="false" class="sentence">
      {{ sentence.text }}
    </div>

    <div id="correction-{{ sentence.id }}" data-alt="false" class="correction mb-2">
      {{ sentence.correction }}
    </div>

    <!-- Accordion -->
    <div class="accordion" id="sentenceAccordion-{{ sentence.id }}">

      <!-- Alt Sentence Accordion Item -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="altSentenceHeading-{{ sentence.id }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#altSentenceCollapse-{{ sentence.id }}" aria-expanded="false"
                  aria-controls="altSentenceCollapse-{{ sentence.id }}">
            Альтернативное исправление
          </button>
        </h2>
        <div id="altSentenceCollapse-{{ sentence.id }}" class="accordion-collapse collapse"
             aria-labelledby="altSentenceHeading-{{ sentence.id }}"">
          <div class="accordion-body">
            <div id="alt-sentence-{{ sentence.id }}" data-sentence-id="{{ sentence.id }}"
                 data-document-id="{{ document.id }}" data-user-id="{{ user.id }}" data-alt="true"
                 class="sentence">
              {{ sentence.text }}
            </div>
            <div id="alt-correction-{{ sentence.id }}" data-alt="true" class="correction">
              {{ sentence.alt_correction }}
            </div>
          </div>
        </div>
      </div>

      <!-- Sentence Markup Accordion Item -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="sentenceMarkupHeading-{{ sentence.id }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#sentenceMarkupCollapse-{{ sentence.id }}" aria-expanded="false"
                  aria-controls="sentenceMarkupCollapse-{{ sentence.id }}">
            Морфологический разбор
          </button>
        </h2>
        <div id="sentenceMarkupCollapse-{{ sentence.id }}" class="accordion-collapse collapse"
             aria-labelledby="sentenceMarkupHeading-{{ sentence.id }}">
          <div class="accordion-body">
            <div id="sentence-markup-{{ sentence.id }}" class="sentence-markup">
              {{ sentence.markup|safe }}
            </div>
          </div>
        </div>
      </div>

    </div>
    <!-- End Accordion -->


  </div>
</div>

              <div id="recogito-{{ sentence.id }}" class="recogito"></div>
            {% endfor %}
            <p class="card-text"><small class="text-muted">{{ document.created_on }}</small></p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    $("#document-status").change(function () {
      var status = $(this).val();
      var documentId = "{{ document.id }}";
      var csrfToken = getCSRFToken();

      $.ajax({
        url: "{% url 'update_document_status' document.id %}",
        method: "POST",
        data: {
          'status': status,
          'csrfmiddlewaretoken': csrfToken,
        },
        success: function (data) {
          if (data.status === 'success') {
            console.log("Document status updated successfully.");
            // reload the page
            location.reload();
          } else {
            console.error("Error updating document status.");
          }
        },
        error: function () {
          console.error("Error updating document status.");
        }
      });
    });

    $(document).ready(function () {
      $('[data-toggle="tooltip"]').tooltip();
    });

    function updateCorrections(sentenceId) {
      const url = `/api/get_corrections/${sentenceId}`;

      $.ajax({
        type: "GET",
        url: url,
        success: function (response) {
          // Update the correction and alt_correction fields on the page
          const correction = response.correction;
          const altCorrection = response.alt_correction;

          $(`#correction-${sentenceId}`).text(correction);
          $(`#alt-correction-${sentenceId}`).text(altCorrection);
        },
        error: function (xhr, status, error) {
          console.error("Error updating corrections:", error);
        }
      });
    }

    function refreshCorrections() {
      {% for sentence in sentences %}
        updateCorrections({{ sentence.id }});
      {% endfor %}
    }

    document.addEventListener('DOMContentLoaded', initRecogito);
  </script>
{% endblock %}